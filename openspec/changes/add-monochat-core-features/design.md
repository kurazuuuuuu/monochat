# Design Document: MonoChatコア機能

## Context
MonoChatは、完全モノクロデザインの匿名掲示板アプリケーションです。ユーザーはパスワードのみで認証し、システムが自動生成したユーザー名で投稿します。本ドキュメントは、アプリケーション全体のアーキテクチャと技術的決定を記述します。

### Background
- 匿名掲示板の雰囲気を重視
- ユーザー登録の障壁を最小化 (メールアドレス不要)
- シンプルで直感的なUI/UX
- モノクロデザインによる統一感

### Stakeholders
- エンドユーザー: 匿名で投稿したいユーザー
- 開発者: システムのメンテナンスと拡張を行う

## Goals / Non-Goals

### Goals
- パスワードのみでの簡単な認証フロー
- 自動生成されたユーザー名による匿名性
- シンプルで直感的な掲示板作成・メッセージ投稿
- 完全モノクロのビジュアルデザイン
- レート制限によるスパム防止

### Non-Goals
- メールアドレスによる認証
- プロフィール画像やカスタマイズ機能
- ダイレクトメッセージ機能
- モデレーション・管理機能 (初期実装では対象外)

## Decisions

### 1. 認証方式: パスワードのみ + JWT
**決定**: パスワードのみで認証し、UUIDとユーザー名はバックエンドで自動生成。認証成功後はJWTトークンを発行。

**理由**:
- 匿名性を保つため、メールアドレスや個人情報を不要に
- UUIDをブラウザに保存し、再ログイン時に使用
- JWTでステートレスな認証を実現

**代替案**:
- セッションベース認証: サーバー側でセッション管理が必要になり、スケーラビリティが低下
- OAuth: 匿名性が損なわれる

### 2. データモデル: UUID使用
**決定**: 全エンティティ (User, Space, Message) に対してUUIDを外部識別子として使用。内部的には整数のIDも保持。

**理由**:
- UUIDは予測不可能で、セキュリティ向上
- 分散システムでの衝突リスクが低い
- Rails標準のActive Recordと互換性がある

**代替案**:
- 連番ID: 予測可能で、セキュリティリスクがある
- ハッシュID: 実装が複雑になる

### 3. ユーザー名生成: ランダム生成
**決定**: ユーザー名は、形容詞+名詞などのパターンで自動生成 (例: "RedPanda", "SilentWolf")。

**理由**:
- ユーザーがユーザー名を選ぶ必要がなく、登録が簡単
- 匿名性を保ちつつ、各ユーザーを識別可能

**実装**:
- 形容詞と名詞のリストをモデルに持たせ、ランダムに組み合わせる
- 重複チェックを行い、ユニーク性を保証

### 4. レート制限: 5秒制限
**決定**: メッセージ投稿に5秒のレート制限を設ける。

**理由**:
- スパム防止
- サーバー負荷の軽減

**実装**:
- Redisまたはメモリキャッシュを使用
- ユーザーUUIDごとに最後の投稿時刻を記録

**代替案**:
- CAPTCHAによる制限: ユーザー体験が悪化
- IP制限: 複数ユーザーが同じIPを使用する場合に問題

### 5. UI/UX: モノクロデザイン + DotGothic16
**決定**: 全UI要素を白・黒・グレーのモノクロで統一。フォントはDotGothic16を使用。

**理由**:
- 匿名掲示板の雰囲気を演出
- レトロで独特な視覚体験
- シンプルで統一感のあるデザイン

**実装**:
- Google Fontsから読み込み
- Tabler IconsをモノクロCSSでスタイリング

### 6. フロントエンド: Rails標準 + Hotwire/Turbo
**決定**: フロントエンドはRails標準のビューレイヤーを使用。リアルタイム更新にはHotwire/Turboを活用。

**理由**:
- 開発速度が速い
- Railsとの統合が容易
- リアルタイム更新を簡単に実装可能

**代替案**:
- React/Vue.js: フロントエンドとバックエンドが分離し、開発が複雑化
- WebSocket: 実装が複雑になる

## Architecture Overview

```
┌─────────────────────────────────────────────────────────┐
│                       Frontend                          │
│   ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│   │  Login   │  │   Home   │  │  Space   │            │
│   │  View    │  │   View   │  │   View   │            │
│   └──────────┘  └──────────┘  └──────────┘            │
│         │             │              │                   │
└─────────┼─────────────┼──────────────┼──────────────────┘
          │             │              │
          ▼             ▼              ▼
┌─────────────────────────────────────────────────────────┐
│                    Rails Backend                        │
│   ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │
│   │    Auth      │  │    Spaces    │  │  Messages   │ │
│   │  Controller  │  │  Controller  │  │  Controller │ │
│   └──────────────┘  └──────────────┘  └─────────────┘ │
│         │                  │                  │         │
│   ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │
│   │     User     │  │     Space    │  │   Message   │ │
│   │     Model    │  │     Model    │  │    Model    │ │
│   └──────────────┘  └──────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│                  PostgreSQL Database                    │
│   ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│   │  users   │  │  spaces  │  │ messages │            │
│   └──────────┘  └──────────┘  └──────────┘            │
└─────────────────────────────────────────────────────────┘
```

## Data Flow

### 1. 認証フロー
1. **初回登録**:
   - ユーザーがパスワードを入力
   - バックエンドがUUID, ユーザー名を生成
   - パスワードをbcryptでハッシュ化してDB保存
   - UUIDとJWTトークンをフロントに返す
   - フロントがUUIDをブラウザに保存

2. **ログイン**:
   - ユーザーがパスワードを入力
   - ブラウザに保存されたUUIDを送信
   - バックエンドがUUID/パスワードで認証
   - 認証成功でJWTトークンを返す

### 2. Space作成フロー
1. ユーザーが「New Space」ボタンをクリック
2. ポップアップで確認
3. バックエンドがSpace UUIDと名前を自動生成
4. DBに保存し、作成されたSpaceにリダイレクト

### 3. メッセージ投稿フロー
1. ユーザーがメッセージを入力し送信
2. レート制限チェック (最後の投稿から5秒経過しているか)
3. メッセージUUID生成、DBに保存
4. リアルタイム更新で他のユーザーにも表示

## Risks / Trade-offs

### Risk 1: パスワード紛失時のアカウント復旧不可
- **リスク**: メールアドレスがないため、パスワードを忘れるとアカウントにアクセスできない
- **緩和策**: ログイン画面に明確な警告を表示し、パスワード管理の重要性を伝える

### Risk 2: UUIDの保存失敗
- **リスク**: ブラウザのローカルストレージが削除されると、UUIDが失われる
- **緩和策**: UUIDをコピーできるUI提供、またはQRコード表示機能

### Risk 3: レート制限の回避
- **リスク**: ユーザーが新しいアカウントを作成してレート制限を回避する可能性
- **緩和策**: IP制限との併用 (ただし、初期実装では対象外)

### Trade-off: シンプルさ vs 機能性
- **選択**: 初期実装ではシンプルさを優先し、モデレーション機能や高度なセキュリティ機能は後回し
- **理由**: MVP (Minimum Viable Product) として素早くリリースし、ユーザーフィードバックを得る

## Migration Plan

### 初期デプロイ
1. データベースマイグレーション実行
2. 環境変数設定 (JWT_SECRET, DATABASE_URL)
3. アプリケーション起動
4. 動作確認

### 今後の拡張
- Space削除機能
- メッセージ編集・削除機能
- モデレーション機能
- 検索機能
- 通知機能

### ロールバック
初期実装のため、ロールバックは単純にアプリケーションを停止し、データベースマイグレーションを元に戻すのみ。

## Open Questions
- ユーザー名生成のパターンは英語のみか、日本語も対応するか?
  - **暫定回答**: 初期実装では英語のみ。将来的に日本語対応を検討
- レート制限はユーザー単位かIP単位か?
  - **回答**: ユーザーUUID単位で実装
- メッセージの最大文字数は?
  - **暫定回答**: 500文字 (後で調整可能)
